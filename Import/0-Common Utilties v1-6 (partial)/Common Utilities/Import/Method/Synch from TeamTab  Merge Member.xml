<AML>
 <Item type="Method" id="2514CD80D27E411AB0FB9C7228A9AC2B" action="add">
  <execution_allowed_to keyed_name="World" type="Identity">A73B655731924CD0B027E4F4D5FCC0A9</execution_allowed_to>
  <method_code><![CDATA['MethodTemplateName=VBMain;
' called onAfterAdd/Update of "team Relationhip"  (i.e. Program Team)
Dim inn As Innovator = Me.getInnovator()
Dim suIdentityWasGranted As Boolean
Dim suIdentity As Aras.Server.Security.Identity 

Function Main() As Item
  'System.Diagnostics.Debugger.Break()
  Dim SQLstr As String = ""
  Dim thisTeamRel As Item = Me.newItem(Me.GetType(),"get")
  thisTeamRel.setID(Me.getID())
  thisTeamRel.setAttribute("select","source_id(team_id,config_id,name),related_id(keyed_name),team_role,team_identity_relship_id")
  thisTeamRel.setAttribute("serverEvents","0")
  thisTeamRel = thisTeamRel.apply()

  If thisTeamRel.isError() Then Return thisTeamRel

  Dim sourceItemId As String = thisTeamRel.getProperty("source_id","")
  Dim sourceItem As Item = thisTeamRel.getPropertyItem("source_id")
  Dim sourceItemType As String = thisTeamRel.getPropertyItem("source_id").getAttribute("type","")
  Dim teamRelTeamRole As String = thisTeamRel.getProperty("team_role","")

  if teamRelTeamRole = "" then return Me ' nothing to do, if role is missing !

  suIdentity = Aras.Server.Security.Identity.GetByName("Administrators")
  suIdentityWasGranted = Aras.Server.Security.Permissions.GrantIdentity(suIdentity)

  Dim teamSystemId As String = sourceItem.getProperty("team_id","")
  Dim teamIdentityRelShipId As String = thisTeamRel.getProperty("team_identity_relship_id","")

  ' create new Team Item
  If teamSystemId = "" Then
     teamSystemId = createTeamItemWithDefinedName (sourceItem.getProperty("name",""),sourceItem.getProperty("config_id",""))
     If teamSystemId.indexOf("ERROR") >= 0 Then
        Return inn.newError(teamSystemId)
     End If 
  End If

  ' resolve teamRole to identity id
  Dim teamRoleId As String = ""
  If teamRelTeamRole.indexOf("Manager") >= 0 Then teamRoleId = "60EBF9D1BB584921A73FA2F8D74DAF80"  'id of identitty "Team Manager"
  If teamRelTeamRole.indexOf("Member") >= 0 Then  teamRoleId = "7635594273054F2BA32C1CADB31FD413"  'id of identitty "Team Member"
  If teamRelTeamRole.indexOf("Guest") >= 0 Then   teamRoleId = "65ABF0DF1F764001A2A91934910ED93D"  'id of identitty "Team Guest"

  ' set team_id and owned_by_id on the sourceItem 
  Dim amlCmd As Item  = updateTeamIdOnProjectSourceItem (sourceItemType,sourceItemId,teamSystemId,teamRoleId,thisTeamRel.getProperty("related_id",""))
  If amlCmd.isError() Then Return returnErrorAndResetPermssion(amlCmd)

  ' merge = add or update members of the PS Team Item
  Dim whereStr As String = ""
  Dim res As Item = Me
  whereStr= "[Team_Identity].source_id='" & teamSystemId  & "'"
  whereStr = whereStr & " and [Team_Identity].related_id='" & thisTeamRel.getProperty("related_id","") & "'"

  amlCmd = inn.newItem("Team Identity","merge")

  If teamIdentityRelShipId <> "" Then
    amlCmd.setAttribute("id",teamIdentityRelShipId)
 
  Else
    amlCmd.setAttribute("where",whereStr)
    amlCmd.setAttribute("version","0")
  End If

  amlCmd.setProperty("source_id",teamSystemId)
  amlCmd.setProperty("related_id",thisTeamRel.getProperty("related_id",""))
  If teamRoleId <> "" Then amlCmd.setProperty("team_role",teamRoleId)

  res = amlCmd.apply()
    
  If res.isError() Then Return returnErrorAndResetPermssion(res)
  
  'store "Team Identity" relationship id in PS Team relationship with SQL
  teamIdentityRelShipId = res.getID()
 
  Dim tableName As String = thisTeamRel.GetType().Replace(" ","_")
  SQLstr = "UPDATE [" & tableName & "]"
  SQLstr = SQLstr & " SET [" & tableName & "].team_identity_relship_id='" & teamIdentityRelShipId & "'"
  SQLstr = SQLstr & " WHERE [" & tableName & "].id='" & thisTeamRel.getID() & "'"
  res = inn.applySQL(SQLstr)
  If res.isError() Then Return returnErrorAndResetPermssion(res)


  If suIdentityWasGranted Then
     Aras.Server.Security.Permissions.RevokeIdentity(suIdentity)
  End If

  Return Me
End Function

'-----------------------------
Private Function returnErrorAndResetPermssion (ByRef errItem As Item ) As Item
 If suIdentityWasGranted Then
   Aras.Server.Security.Permissions.RevokeIdentity(suIdentity)
 End If
 Return errItem
End Function

'-----------------------------
Private Function createTeamItemWithDefinedName (sourceItemName As String, sourceItemConfigId As String) As String

  'try to find team item with this name
  Dim amlCmd As Item = inn.newItem("Team","get")
  amlCmd.setProperty("name","TM_" & sourceItemName)
  amlCmd.setPropertyAttribute("description","condition","like")
  amlCmd.setProperty("description", "%" & sourceItemConfigId & "%")
  amlCmd.setAttribute("select","id")
  amlCmd = amlCmd.apply()

  Dim teamId As String = ""  
  If amlCmd.getItemCount() = 0 Then

    amlCmd = inn.newItem("Team","add")
    amlCmd.setProperty("name","TM_" & sourceItemName)
    amlCmd.setProperty("description", "config-" & sourceItemConfigId)
    amlCmd = amlCmd.apply()
    If amlCmd.isError() Then Return "ERROR:" + amlCmd.getErrorString()

  End If
  teamId = amlCmd.getItemByIndex(0).getAttribute("id","")

  If teamId <> "" Then  Return teamId
  
  Return "ERROR: Cannot find or create Team item for this Item!"  
End Function

'-----------------------------
Private Function updateTeamIdOnProjectSourceItem (sourceItemType As String,sourceItemId As String,teamId As String,teamRoleId As String, teamMemberId As String) As Item

  Dim tableName As String = sourceItemType.Replace(" ","_")
  Dim SQLstr As String = "UPDATE [" & tableName & "]"
  SQLstr = SQLstr & " SET [" & tableName & "].team_id='" & teamId & "'"

  'if team roles is Manager --> also set the Owner
  If teamMemberId <> "" And teamRoleId = "60EBF9D1BB584921A73FA2F8D74DAF80" Then
    SQLstr = SQLstr & ",[" & tableName & "].owned_by_id='" & teamMemberId & "'"
  End If
  SQLstr = SQLstr & " WHERE [" & tableName & "].id='" & sourceItemId & "'"
  Return inn.applySQL(SQLstr)
    
End Function
]]></method_code>
  <method_type>VB</method_type>
  <name>Synch from TeamTab  Merge Member</name>
 </Item>
</AML>