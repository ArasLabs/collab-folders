<AML>
 <Item type="Method" id="E451C53712C34839979EE6EA07DE1CEC" action="add">
  <execution_allowed_to keyed_name="World" type="Identity">A73B655731924CD0B027E4F4D5FCC0A9</execution_allowed_to>
  <method_code><![CDATA['MethodTemplateName=VBMain;
Dim inn As Innovator = Me.getInnovator()
Dim res As Item
'
' Server Events: onAfterAdd/Update
'
' check if new folder has property "item_folder_template_id" set.
' and if property "top_item_folder_id" is set

' if set, call generic method that does the cloning of the structure 
' of Sub folders from the folder template
'
Function Main() As Item
  'System.Diagnostics.Debugger.Break()
  Dim thisItemType As String = Me.GetType()
  Dim thisItemId As String = Me.GetID()

  Dim qry As Item = inn.newItem(thisItemType,"get")
  qry.setID(thisItemId)
  qry.setAttribute("serverEvents","0")
  qry.setAttribute("select","item_folder_template_id,top_item_folder_id")
  Dim thisItem As Item = qry.apply() ' fetch this item from server
  
  Dim topFolderId As String = thisItem.getProperty("top_item_folder_id","")
  Dim folderTemplId As String = thisItem.getProperty("item_folder_template_id","")
  
  If topFolderId = "" Or folderTemplId = "" Then Return Me ' nothing to do

  ' get the top folder item
  qry = inn.newItem("Item Folder","get")
  qry.setID(topFolderId)
  qry.setAttribute("serverEvents","0")
  qry.setAttribute("select","name,item_folder_template_id")
  Dim topFolderItem As Item = qry.apply()
  If topFolderItem.isError() Then Return topFolderItem
  
  'inherit template id to to top folder
  Dim SQLstr As String = "UPDATE [Item_Folder]"
  SQLstr = SQLstr & " SET [Item_Folder].item_folder_template_id='" & folderTemplId & "'"
  SQLstr = SQLstr & " WHERE [Item_Folder].id='" & topFolderId & "'"
  qry = inn.applySQL(SQLstr)
  If qry.isError() Then Return qry
  
  ' call generic method with thisItem context
  topFolderItem.setAction("Create Folder Struct from Templ")
  topFolderItem = topFolderItem.apply()
  If topFolderItem.isError() Then Return topFolderItem
  
  Return Me
End Function  

]]></method_code>
  <method_type>VB</method_type>
  <name>Add TemplStuct to rel TopFolder</name>
 </Item>
</AML>