<AML>
 <Item type="Method" id="226369A462964B6ABC146012FEDE614D" action="add">
  <execution_allowed_to keyed_name="World" type="Identity">A73B655731924CD0B027E4F4D5FCC0A9</execution_allowed_to>
  <method_code><![CDATA[// =======================================================
// JavaScript Method to "handle" grid menu custom actions on Folder Tree Grid
//
// is loaded with Form "configStructure Grid" 
//   "CommonBase GridUtiltities"
//   "CommonBase GridConfiguration"
//   must be loaded before method "configStructure GridHandler"
//  
// If you want to create your own specialized menu actions logic, you can CLONE this JS method and then
// modify its logic to be used instead.
// Then you must replace the grid event on Form "configStructure Grid" with your new method.
//
// Rolf Laudenbach
// 2015
// =======================================================

//+++++  BEGIN: Custom Menu Actions Handler
//-----------------
customMenuAction = function customMenuActionFunc() {
};

// NOTE: to add your new action, you must add logic in 3 places:
//        ShowOnMenuCustom, ValidateAction, ExecuteAction

customMenuAction.prototype.isShowOnMenuCustom = function customMenuAction_isShowOnMenuCustom(eActionArgs, menuAction) {
	// this logic must return true, if menu action is to be shown on context menu
	//      or false, if menu action should is not to be shown.

	// determine to show custom actions on menu that are row type independent here (if required)
	if (menuAction.name === "xx_action_show_always") {return true;}

	// determine to show custom actions on menu that are fired from phantom rows
	if (eActionArgs.isPhantomRow) {
		switch (menuAction.name) {
			case "xx_action":
				return true;
				//break;
		}
	}
	
	// determine to show custom actions on menu that are row type specific here (if required)
    switch(eActionArgs.rowItemType)
	{
	case "cFolder":
		switch (menuAction.name) {
			case "refresh_this_row":
			case "add_controlled_item_new":
			case "add_controlled_item_pick":
			case "add_new_file":
			case "add_sub_folder":
			case "delete_sub_folder":
			case "delete_root_folder":
			case "save_structure_to_root_folder":
			case "promote_folder_to_active_down":
			case "promote_folder_to_released_down":
			case "promote_folder_to_archived_down":
			case "add_new_url":
			case "expand_sub_folders":
			case "cut_folder":
			case "paste_folder":
			case "save_structure_to_root_folder":
				return true;
				//break;
		}
		break;

	case "cFolder URL":
		switch (menuAction.name) {
			case "delete_url":
				return true;
		}
		break;

	case "File":
		switch (menuAction.name) {
			case "delete_file":
				return true;
				//break;
		}
		break;
	default:
		switch (menuAction.name) {
			case "delete_controlled_item":
			case "remove_controlled_item":
			case "update_to_current_version":
				return true;
				//break;
		}
		break;
	}
	return false;	
};

/* see documentation on context for eActionArgs and menuAction in  method "CommonBase GridUtilities"
*/
customMenuAction.prototype.executeAction = function customMenuAction_executeAction(eActionArgs, menuActionName) {
  eActionArgs.baseMenuActionHandler = 	eActionArgs.gridHandler.baseMenuActionHandler;
  fn_onToolbarAndMenuClickLocalAction(eActionArgs, menuActionName, this);
  return "";
};
customMenuAction.prototype.validateAction = function customMenuAction_validateAction(eActionArgs, menuAction) {
  //returns "" if validations are OK. Else the function returns an Error message.
  return fn_ValidateActionRequest(eActionArgs, menuAction, this);
};
//^^^^^  END: Custom Menu Actions Handler

//+++++  BEGIN: local helper functions

//+++++ custom validation functions
fn_ValidateActionRequest = function (eActionArgs, menuAction) {
  // run various custom checks specific to action
  // this logic must return "" if validations are ok.
  // or an error message, if validations ar NOT ok.
  //debugger;
  
  // check actions that do not require a selected row
  var checkForRowType = true;
  if (eActionArgs.actionSource === "toolbar") {
	  switch (menuAction.name)
	  {
		  case "clear_search":
		  case "run_search":
	  	  case "create_root_folder":
			return ""; // no further checks
			
	  	  case "delete_root_folder":
			checkForRowType = false;
			break;
	  }
  }

  // continue with check actions that do require selected row
  if (eActionArgs.rowId === undefined || eActionArgs.rowId === "") {
		return top.aras.AlertError(top.aras.getResource("ItemFolders", "itemfoldertreegrid.message.error_row_must_be_selected_for_action"));
  }
  
  if (checkForRowType && (!menuAction.allowOnGroupRows || menuAction.allowOnGroupRows === undefined) && menuAction.relQueryName !== "default" && menuAction.relQueryName !== eActionArgs.rowOfGroupName) {
    return top.aras.getResource("CommonUtilities","commonUtilities.message.action_not_allowed_on_rows_of_this_type");
  }
  
  var checkForNewerVersionOfItem = false;
  if ((eActionArgs.checkForNewerVersionOfItem && eActionArgs.checkForNewerVersionOfItem === true) || (eActionArgs.checkForNewerVersionOfItem !== undefined && eActionArgs.effectivityMode === "current_config"))
	{checkForNewerVersionOfItem = true;}
	
  //## tbd  - check if flag "is_current" is set on row item, if not --> error
  //if (menuAction.ifItemIsCurrentVersion) {
  //
  //}
	
  var disallowOnRootItems = false; 
  var onRootItemsOnly = false; 
  var itemId, rowId;
  var checkMsg = "";  
  switch (menuAction.name)
  {
    // add additional validation logic for your custom actions
	case "add_sub_folder":
		checkForNewerVersionOfItem =false;
		checkMsg = fn_checkIfSubFoldersOnThisFolderAllowed(eActionArgs.rowItemId);
		if (checkMsg !== "") {return checkMsg;}
	  break;

	case "delete_sub_folder":
		checkForNewerVersionOfItem =false;
		disallowOnRootItems = true;
	  break;

    case "delete_root_folder":
		checkForNewerVersionOfItem =false;
		onRootItemsOnly = true;
	  break;

	case "add_new_file":
		checkForNewerVersionOfItem =false;
		
		rowId = fn_getValidFolderRowId (eActionArgs);
		if (!rowId) {top.aras.AlertError(top.aras.getResource("ItemFolders", "itemfoldertreegrid.message.error_getting_parent_of_grid_row")); return;}

		itemId = eActionArgs.gridHandler.getGridRowUserData(rowId,"rowItemID");
		checkMsg = fn_checkIfAttachmentsOnThisFolderAllowed(itemId);
		if (checkMsg !== "") {top.aras.AlertError(checkMsg);return;}
 	  break;

    case "delete_file":
	case "add_new_url":
	case "delete_url":
		checkForNewerVersionOfItem =false;
	  break;

	case "add_controlled_item_new":
	case "add_controlled_item_pick":
		checkForNewerVersionOfItem =false;
		
		rowId = fn_getValidFolderRowId (eActionArgs);
		if (!rowId) {top.aras.AlertError(top.aras.getResource("ItemFolders", "itemfoldertreegrid.message.error_getting_parent_of_grid_row")); return;}

		itemId = eActionArgs.gridHandler.getGridRowUserData(rowId,"rowItemID");
		checkMsg = fn_checkIfControlledItemsOnThisFolderAllowed(itemId);
		if (checkMsg !== "") {top.aras.AlertError(checkMsg);return;}
	  break;
	  
	}
  if (checkForNewerVersionOfItem) { //## to be fixed
    var itm = fn_GetItemsOfCurrentGeneration(eActionArgs.rowItemType,eActionArgs.rowItemId,"id");
	if (itm.getID() != eActionArgs.rowItemId)
        {return top.aras.getResource("CommonUtilities","commonUtilities.message.newer_item_version_found_refresh_grid_first");}
  }
  if (onRootItemsOnly) {
    // check selected rowId
    if (eActionArgs.gridHandler.grid.getParentId(eActionArgs.rowId))
      {return top.aras.getResource("CommonUtilities","commonUtilities.message.action_only_allowed_on_root_rows");}
  }
  if (disallowOnRootItems) {
    // check selected rowId
    if (!eActionArgs.gridHandler.grid.getParentId(eActionArgs.rowId))
      {return top.aras.getResource("CommonUtilities","commonUtilities.message.action_not_allowed_on_root_rows");}
  }
  // success
  return "";
};

//---------------
fn_checkIfAttachmentsOnThisFolderAllowed = function (folderItemId) {
  var itm = top.aras.newIOMItem("","");
  itm.loadAML("<Item type='cFolder' action='get' serverEvents='0' id='"+folderItemId+"' select='status,allow_sub_folder,allowed_relationships' />");
  itm = itm.apply();
  
  var allowedRelsMode = itm.getProperty("allowed_relationships","attachments_and_controlled_items");  //if prop not set use this default
  
  if (allowedRelsMode !== "" && allowedRelsMode.indexOf("attachments") >= 0) {return "";}  // is allowed
  
  return top.aras.getResource("ItemFolders", "itemfoldertreegrid.message.adding_files_to_folder_not_allowed");
};

//---------------
fn_checkIfControlledItemsOnThisFolderAllowed = function (folderItemId) {
  var itm = top.aras.newIOMItem("","");
  itm.loadAML("<Item type='cFolder' action='get' serverEvents='0' id='"+folderItemId+"' select='status,allow_sub_folders,allowed_relationships' />");
  itm = itm.apply();
  
  var allowedRelsMode = itm.getProperty("allowed_relationships","attachments_and_controlled_items");  //if prop not set use this default
  
  if (allowedRelsMode !== "" && allowedRelsMode.indexOf("controlled_items") >= 0) {return "";}  // is allowed
  
  return top.aras.getResource("ItemFolders", "itemfoldertreegrid.message.adding_ctrld_items_to_folder_not_allowed");
};

//---------------
fn_checkIfSubFoldersOnThisFolderAllowed = function (folderItemId) {
  var itm = top.aras.newIOMItem("","");
  itm.loadAML("<Item type='cFolder' action='get' serverEvents='0' id='"+folderItemId+"' select='status,allow_sub_folders,allowed_relationships' />");
  itm = itm.apply();

  var allowSubFolders = itm.getProperty("allow_sub_folders","");
  if (allowSubFolders === "") {allowSubFolders = "1";}  // if prop not set, then allow subfolders
  
  if (allowSubFolders === "1") {return "";}  // is allowed
  
  return top.aras.getResource("ItemFolders", "itemfoldertreegrid.message.adding_sub_folder_not_allowed");
};

//^^^^^ Custom validation functions

//+++++ Custom menu actions
fn_onToolbarAndMenuClickLocalAction = function (eActionArgs, menuActionName, menuActionHandler) {
	// dispatches the menu action to local handlers
	//debugger;
	var actionId = eActionArgs.actionSource + "." + menuActionName;
	var plannedAction = "";

	// NOTE: toolbar actions like : expand, collapse, refresh are covered directly by toolbar click event
	switch(actionId)
	{
	  //+++ your custom action cases ...

	  case "toolbar.create_root_folder":
		fn_onCreateRootFolder(eActionArgs);
	  	break;
	  case "toolbar.delete_root_folder":
		//(validations ensure that selected row is a root row)
		fn_onDeleteFolderWithSubFolders(eActionArgs, top.aras.getResource("ItemFolders", "itemfoldertreegrid.message.confirm_delete_folder_with_sub_folders"));
	  	break;
	  case "toolbar.run_search":
		eActionArgs.gridHandler.gridRefresh(true);
		break;
	  case "toolbar.clear_search":
		eActionArgs.gridHandler.toolbar.getActiveToolbar().getElement('search_text').setText("");
		break;
	  case "menu.save_structure_to_root_folder":
		fn_onSaveFolderStructToNewRootFolder(eActionArgs);
	  	break;
	  case "menu.refresh_this_row":
		fn_onRefreshThisFolder(eActionArgs, true);
	  	break;
	  case "menu.add_controlled_item_new":
	  case "menu.g_add_controlled_item_new":
		fn_onAddControlledItem(eActionArgs, true);
	  	break;
	  case "menu.add_controlled_item_pick":
	  case "menu.g_add_controlled_item_pick":
		fn_onAddControlledItem(eActionArgs, false);
	  	break;
	  case "menu.update_to_current_version":
	    fn_onUpdateControlledItemToCurrentVersion(eActionArgs);
	  	break;
	  case "menu.delete_controlled_item":
	    fn_onDeleteFolderRelatedItem(eActionArgs, "cFolder Controlled Item", false, top.aras.getResource("ItemFolders", "itemfoldertreegrid.message.confirm_delete_ctrld_item_and_remove_from_folder"), true, true);
	  	break;
	  case "menu.remove_controlled_item":
	    fn_onDeleteFolderRelatedItem(eActionArgs, "cFolder Controlled Item", false, top.aras.getResource("ItemFolders", "itemfoldertreegrid.message.confirm_remove_ctrld_item_from_this_folder"), false);
	  	break;
	  case "menu.add_new_file":
	     fn_onAddFileToFolder(eActionArgs);
	  	break;
	  case "menu.delete_file":
	    fn_onDeleteFolderRelatedItem(eActionArgs, "cFolder File", false, top.aras.getResource("ItemFolders", "itemfoldertreegrid.message.confirm_delete_file_from_this_folder"), true);
	  	break;
	  case "menu.add_new_url":
	     fn_onAddURLtoFolder(eActionArgs);
	  	break;
	  case "menu.delete_url":
		fn_onDeleteFolderRelatedItem(eActionArgs, "cFolder URL", true, top.aras.getResource("ItemFolders", "itemfoldertreegrid.message.confirm_delete_url_from_this_folder"), false);
	  	break;
	  case "menu.add_sub_folder":
		fn_onAddSubFolder(eActionArgs);
	  	break;
	  case "menu.delete_sub_folder":
		fn_onDeleteFolderWithSubFolders(eActionArgs, top.aras.getResource("ItemFolders", "itemfoldertreegrid.message.confirm_delete_folder_with_sub_folders"));
	    //##cannot have files,or controlled items -- fn_onDeleteFolderRelatedItem(eActionArgs, "Sub cFolder", false, top.aras.getResource("ItemFolders", "itemfoldertreegrid.message.confirm_delete_sub_folder_from_this_folder"), true);
	  	break;
	  case "menu.promote_folder_to_active_down":
	    fn_onPromoteFoldersDown(eActionArgs, "Active");
	  	break;
	  case "menu.promote_folder_to_released_down":
	    fn_onPromoteFoldersDown(eActionArgs, "Released");
	  	break;
	  case "menu.promote_folder_to_archived_down":
	    fn_onPromoteFoldersDown(eActionArgs, "Archived");
	  	break;
	  case "menu.expand_sub_folders":
		var childIds = eActionArgs.gridHandler.grid.getChildItemsId(eActionArgs.rowId, true, "|").split("|");
		var numNodes = eActionArgs.gridHandler.CONFIG.getValue("expandFolderWarningNodes","20");
		if (childIds.length > parseInt(numNodes)) {
			if (!confirm(top.aras.getResource("ItemFolders", "itemfoldertreegrid.message.confirm_expand_all_subfolders_N").format(childIds.length)))
				{return;}
		}
		eActionArgs.gridHandler.grid.openItem(eActionArgs.rowId);
	    fn_onExpandSubFolders(eActionArgs.gridHandler.grid,childIds);
	  	break;

	  default:
		alert("Menu Action '"+actionId+"' id not implemented, yet");
	  	break;
	}
	//^^^ your custom actions
};

//-----------------
fn_myActionHandler = function (eActionArgs) {
	alert ("execute my_menu_action");
  return;
};

//-----------------
fn_onCreateRootFolder = function (eActionArgs) {
	// Do a client-side add of the folder item. The new item will not be in the database until the user saves it
	var item = top.aras.newItem("cFolder");
	top.aras.itemsCache.addItem(item);
	var folderId = item.getAttribute("id");
	top.aras.uiReShowItemEx(folderId, item, "tab view");
	top.aras.uiShowItemEx(item, "tab view");
	eActionArgs.gridHandler.gridRefresh(true);
	//top.aras.AlertSuccess(top.aras.getResource("CommonUtilities","commonUtilities.message.refreh_grid_to_see_results"));
	return true;
};

//-----------------
fn_onSaveFolderStructToNewRootFolder = function (eActionArgs) {
	var includeRels = true;
	if (!top.aras.confirm(top.aras.getResource("ItemFolders", "itemfoldertreegrid.message.confirm_save_folder_to_new_root_folder_with_rels"))) {includeRels=false;}

	// Do a client-side add of the folder item. The new item will not be in the database until the user saves it
	var item = top.aras.newItem("cFolder");
	top.aras.itemsCache.addItem(item);
    var selectedFolderItemId = eActionArgs.gridHandler.getGridRowUserData(eActionArgs.rowId,"rowItemID");
	top.aras.setItemProperty(item,"copied_from_folder_ref",selectedFolderItemId);
	
	if (includeRels) {
		var folderItemRelNames = eActionArgs.gridHandler.CONFIG.getGridStructureRowRelShipDefinitions(eActionArgs.gridHandler.viewName);
		var folderRelationships = "",sep="";
		for (var relQueryName in folderItemRelNames) {folderRelationships += sep + folderItemRelNames[relQueryName].relationshipName; sep=",";}
		item.setAttribute("folderRelationshipsToCopy",folderRelationships);
	}
	var folderId = item.getAttribute("id");
	top.aras.uiReShowItemEx(folderId, item, "tab view");
	top.aras.uiShowItemEx(item, "tab view");
	eActionArgs.gridHandler.gridRefresh(true);
	//top.aras.AlertSuccess(top.aras.getResource("CommonUtilities","commonUtilities.message.refreh_grid_to_see_results"));
	return true;
};

//-----------------
fn_onDeleteFolderWithSubFolders = function (eActionArgs, confirmMsg) {
	// fetch selected item from server
	if (!top.aras.confirm(confirmMsg)) {return;}

	var folderItem = innovator.getItemById(eActionArgs.rowItemType, eActionArgs.rowItemId);

	var folderItemRelNames = eActionArgs.gridHandler.CONFIG.getGridStructureRowRelShipDefinitions(eActionArgs.gridHandler.viewName);
	var folderRelationships = "",sep="";
	for (var relQueryName in folderItemRelNames) {folderRelationships += sep + folderItemRelNames[relQueryName].relationshipName; sep=",";}
	
	//call server method to do the work.
	folderItem.setAttribute("folderRelationships",folderRelationships);
	folderItem = folderItem.apply("Delete cFolder with SubFolders");
	
	if (folderItem.isError()) {
		var msg = folderItem.getErrorString();
		if (folderItem.getErrorString() === "Some folders are still locked") {
		  msg = top.aras.getResource("ItemFolders", "itemfoldertreegrid.message.error_some_folders_still_locked");

		}
		top.aras.AlertError(msg); return false;
	}
	
	//remove rows from grid
	var childIds = eActionArgs.gridHandler.grid.getChildItemsId(eActionArgs.rowId, true, "|").split("|");
	for (var i=0; i<childIds.length && childIds[0] !== ""; i++) {
		eActionArgs.gridHandler.grid.deleteRow(childIds[i]);
	}	
	eActionArgs.gridHandler.grid.deleteRow(eActionArgs.rowId);

	return true;
};

//-----------------
fn_onAddSubFolder = function (eActionArgs) {
	if (!eActionArgs.rowId) {return;}
	var callback = {
		oncancel: function(dlgRes) {
			var res = dlgRes.result;
			if (!res || res === undefined || res === "") {return;}
			
			gridHandler = eActionArgs.gridHandler;
			folderRowId = eActionArgs.rowId;
			folderItemId = eActionArgs.rowItemId;

			// Create new SubFolder Rel and new Folder Item
			var folderItemRel = top.aras.newIOMItem("Sub cFolder","add");
			if (res.org_number && res.org_number !== "") {folderItemRel.setProperty("org_number", res.org_number);}
			folderItemRel.setProperty("source_id", folderItemId);
			var subFolderItem = top.aras.newIOMItem("cFolder","add");
			subFolderItem.setProperty("name",res.name);
			if (res.description && res.description !== "") {subFolderItem.setProperty("description",res.description);}
			folderItemRel.setRelatedItem(subFolderItem);
		 
			folderItemRel = folderItemRel.apply(); //add new relationship on server
			if (folderItemRel.isError()) {
				top.aras.AlertError(top.aras.getResource("ItemFolders", "itemfoldertreegrid.message.add_sub_folder_error") + folderItemRel.getErrorString());
				return;
			}

			// retrieve new relationship with more details from server
			var amlQry = gridHandler.CONFIG.buildGridDataRelShipQueryAML(gridHandler.viewName, "Sub cFolder", folderItemId, subFolderItem.getID(), false, true);  // false = isReleased, true = isStructureRel
			var qry = top.aras.newIOMItem("","");
			qry.loadAML(amlQry); 
			folderItemRel = qry.apply();
			if (folderItemRel.getItemCount() <=0) { // error: no controlled items for this folder 
				top.aras.AlertError(top.aras.getResource("ItemFolders", "itemfoldertreegrid.message.add_sub_folder_error") + folderItemRel.getErrorString());
				return;
			}
			folderItemRel = folderItemRel.getItemByIndex(0);
			subFolderItem = folderItemRel.getRelatedItem();
			parentFolderItem = folderItemRel.getPropertyItem("source_id");
			parentItemConfigId = parentFolderItem.getProperty("config_id");

			// Draw new sub folder row
			var rowConfig = {};
			rowConfig.rowIcon = gridHandler.CONFIG.getGridStructureRowIcon();
			var rowId = gridHandler.DrawStructureRow (gridHandler.structureRelName, subFolderItem, folderItemRel, parentItemConfigId, folderRowId, rowConfig, false); 
			fn_refreshGridAndShowRow (eActionArgs.gridHandler, rowId);
			return;			
		}
	};
	fn_showFormInModalDialog("cFolder Add SubFolder", "Add New Sub Folder", eActionArgs.rowItemType, null, callback);
};
	
//-----------------
fn_onRefreshThisFolder = function (eActionArgs, reloadData) {
	// first remove rows from grid
	var parentFolderRowId = eActionArgs.gridHandler.grid.getParentId(eActionArgs.rowId);
	var parentFolderId = eActionArgs.gridHandler.getGridRowUserData(parentFolderRowId,"rowItemID");
	var folderItemId = eActionArgs.gridHandler.getGridRowUserData(eActionArgs.rowId,"rowItemID");
	
	var childIds = eActionArgs.gridHandler.grid.getChildItemsId(eActionArgs.rowId, true, "|").split("|");
	var i;
	for (i=0; i<childIds.length && childIds[0] !== ""; i++) {
		eActionArgs.gridHandler.grid.deleteRow(childIds[i]);
	}	
	eActionArgs.gridHandler.grid.deleteRow(eActionArgs.rowId);
	// now re-build sub structure of this folder from loaded data -  data is in array of AML results. one for each root row
	var AMLarray = eActionArgs.gridHandler.gridData_AML;
	var dataItem = null;
	for (i=0; i<AMLarray.length && dataItem === null; i++) {
		dataItem = AMLarray[i].getItemsByXPath("//Item[@type='Sub cFolder' and source_id='"+parentFolderId+"']");
		if (dataItem.getItemCount() === 0) {
			dataItem = null; // continue, if not found
		}
		else {
			var relItem = null;
			for (var j=0; j<dataItem.getItemCount() && relItem === null; j++) {
				var relItemId = dataItem.getItemByIndex(j).getProperty("related_id");
				if (relItemId === folderItemId) {
					relItem = dataItem.getItemByIndex(j);
				}
			}
			dataItem = relItem;
		}
	}
	if (dataItem !== null) {
		var folderItem;
		if (reloadData) {
			//folderItem = dataItem.getPropertyItem("related_id");
			//dataItem.removeItem(folderItem);
			folderItem = eActionArgs.gridHandler.GetGridData("cFolder",folderItemId);
			dataItem.setRelatedItem(folderItem);
		}
		eActionArgs.gridHandler.gridRefresh(false);
	/*
		else {
			folderItem = dataItem.getPropertyItem("related_id");
		}
		if (folderItem) {
			var rowConfig = {};
			rowConfig.rowIcon = eActionArgs.gridHandler.CONFIG.getGridStructureRowIcon();
			rowConfig.isApplyChildBgColorUpToRoot = eActionArgs.gridHandler.CONFIG.isApplyChildBgColorUpToRoot();
			rowConfig.bgColorOfStructItemWithChildren = eActionArgs.gridHandler.CONFIG.getBgColorOfStructItemWithChildren();
			rowConfig.doNotColorRootRows = !eActionArgs.gridHandler.isStartedFromTOCview;
		
			var	rowId = eActionArgs.gridHandler.DrawStructureRow (eActionArgs.gridHandler.structureRelName, folderItem, dataItem, parentFolderRowId, null, rowConfig);  //"BaseGridMain Utilities" function
									
			var parents = {}; //needed for recursive calls to resolve multi-level children of structure
			eActionArgs.gridHandler.DrawStructureRowChildren(eActionArgs.gridHandler.structureRelName, folderItem, folderItem.getProperty("config_id",""), rowId, parents, rowConfig); //"BaseGridMain Utilities" function
		}
	*/
	}
	return;
};


//-----------------
fn_onAddControlledItem = function (eActionArgs, isNew) {
  var rowId = eActionArgs.rowId;
  if (!rowId) {top.aras.AlertError(top.aras.getResource("ItemFolders", "itemfoldertreegrid.message.error_getting_parent_of_grid_row")); return;}
  
  var folderItemId = eActionArgs.gridHandler.getGridRowUserData(rowId,"rowItemID");

  var res = null;
  if (isNew) {
    // Create temporary Item
    res = fn_AddNewControlledItemToFolder(folderItemId, top.aras.newItem("Folder Controlled Item", "add"));
	if (res.isError()) {top.aras.AlertError(top.aras.getResource("ItemFolders", "itemfoldertreegrid.message.add_ctrld_item_error") + res.getErrorString()); return;} 

	fn_refreshGridAndShowRow (eActionArgs.gridHandler, rowId);
	return;
  }
  else {
	var callback = function (selectedItems) {
		if(!selectedItems) {return false;} // cancelled or no item selected
		//res = top.aras.getItemFromServer("Folder Controlled Item", selectedItems[i]);
		res = fn_AddSelectedControlledItemToFolder(folderItemId, selectedItems);
		if (!res) 
			{top.aras.AlertError(top.aras.getResource("ItemFolders", "itemfoldertreegrid.message.add_ctrld_item_error") + res.getErrorString()); return;}
		
		fn_refreshGridAndShowRow (eActionArgs.gridHandler, rowId);
		return;
    };
	eActionArgs.baseMenuActionHandler.searchItem("Folder Controlled Item", 800, 500, callback, true); // true means allow multiselect
  }
};
// -------------
fn_AddNewControlledItemToFolder = function (parentFolderId, newCtrldItem)
{
	var ctrldItemType;
	
	  //do auto numbers (like on folder Template
	  ctrldItemType = newCtrldItem.getAttribute("type");
	  var methodName = "";
	  switch (ctrldItemType)
	  {
	  case "Document":
		methodName = "Folder Template Default DocNum";
		break;
	  case "CAD":
		methodName = "Folder Template Default CADNum";
		break;
	  case "Part":
		methodName = "Folder Template Default PartNum";
		break;
	  }
	  if (methodName !== "") {
		  var runMethod = top.aras.newIOMItem(ctrldItemType,methodName);
		  runMethod = runMethod.apply();
		  if (runMethod.isError()) {return innovator.newError("Cannot create auto number for type '"+ctrldItemType+"' !");}

		  top.aras.setItemProperty(newCtrldItem,"item_number",runMethod.getResult());
		  //## TODO - add new item and relationship in cache instead of server - like standard "create related" on relationships ???
	  }
	  else {
		//return innovator.newError("Auto number logic for new items not defined for type '"+ctrldItemType+"' !");
	  }	

	//add the new relationship on server
	var relName = "cFolder Controlled Item";
	var folderItemRel;
	folderItemRel = top.aras.newIOMItem(relName,"add");
	folderItemRel.setProperty("source_id", parentFolderId);
	var ctrldItem = top.aras.newIOMItem("Folder Controlled Item");
	ctrldItem = top.aras.newIOMItem("Folder Controlled Item");
	ctrldItem.loadAML(newCtrldItem.xml);
	folderItemRel.setRelatedItem(ctrldItem);
 
	folderItemRel = folderItemRel.apply(); 
	if (folderItemRel.isError()) {return folderItemRel;}
	
	/*
	top.aras.itemsCache.addItem(newCtrldItem);
	top.aras.uiShowItemEx(newCtrldItem, "tab view");
	*/
  return folderItemRel;
};
// ----------------
fn_AddSelectedControlledItemToFolder = function (parentFolderId, itemIdsArray)
{
	var aml = '<AML>';
	
	for (var i=0;i<itemIdsArray.length;i++) {
		//add the new relationship on server
		aml += '<Item type="cFolder Controlled Item" action="merge" where="';
		aml += '[cFolder_Controlled_Item].source_id=\''+parentFolderId+'\' and ';
		aml += '[cFolder_Controlled_Item].related_id=\''+itemIdsArray[i]+'\'" >';
		
		aml += '<source_id>'+parentFolderId+'</source_id>';
		aml += '<related_id>'+itemIdsArray[i]+'</related_id>';
		aml += '</Item>';
		
		var folderItemRel;
	}
	aml += "</AML>";
	
	var res = top.aras.applyAML(aml);
	if (!res || res === undefined) {return false;}
	return true;
};

//-----------------
fn_onUpdateControlledItemToCurrentVersion = function (eActionArgs) {
  var selectedId = eActionArgs.rowId;
  if (!selectedId) {return;}

  var itemType = eActionArgs.rowItemType;
  var itemId = eActionArgs.rowItemId;

  var parentId = eActionArgs.gridHandler.grid.getParentId(selectedId);
  if (parentId)
  {
    var parentItemId = eActionArgs.gridHandler.getGridRowUserData(parentId,"rowItemID");
    var parentItemType = eActionArgs.gridHandler.getGridRowUserData(parentId,"rowItemType");

    // check if user is owner of parent item
	var checkItem = fn_checkCurrentUserIsOwnerOfThisItem(parentItemType,parentItemId);
    if (checkItem.isError()) {top.aras.AlertError(top.aras.getResource("ItemFolders", "itemfoldertreegrid.message.user_is_not_owner") + checkItem.getErrorString());return;}
	
	alert("not implemented,yet !!!");
	
	// read relationship item "cFolder Controlled Item" with related_id = itemId from loaded AML (XPath)
	
	// get current version of of "itemId"  (then select configured props)
	
	// replace realtedItem on relationship with item of current version.
	
	// do a refresh(false);

    return;
  }
  
};

//-----------------
fn_onAddFileToFolder = function (eActionArgs) {
  var rowId = eActionArgs.rowId;
  if (!rowId) {top.aras.AlertError(top.aras.getResource("ItemFolders", "itemfoldertreegrid.message.error_getting_parent_of_grid_row")); return;}

  var fileItem = top.aras.newItem("File");

  var xml = fileItem.xml;
  fileItem = top.aras.newIOMItem("File");
  fileItem.loadAML(xml);
  fileItem.setAction("add");

  var parentFolderId = eActionArgs.rowItemId;
  var folderFileRel = top.aras.newIOMItem("cFolder File","add");
  folderFileRel.setProperty("source_id", parentFolderId);
  folderFileRel.setRelatedItem(fileItem);
  folderFileRel = folderFileRel.apply(); //triggers upload to vault.
  if (folderFileRel.isError()) {top.aras.AlertError(top.aras.getResource("ItemFolders", "itemfoldertreegrid.message.add_file_error") + folderFileRel.getErrorString()); return;}

  fn_refreshGridAndShowRow (eActionArgs.gridHandler, rowId);

  return;
};

//-----------------
fn_onAddURLtoFolder = function (eActionArgs) {
	if (!eActionArgs.rowId) {return;}

	var callback = {
		oncancel: function(dlgRes) {
			var res = dlgRes.result;
			if (!res || res === undefined || res === "") {return;}

			if (res.url.indexOf("http") !== 0) {
				if (!top.aras.confirm(top.aras.getResource("ItemFolders", "itemfoldertreegrid.message.confirm_add_http_to_url"))) {return false;}
				res.url = "http://"+res.url;
			}

			var rowId = eActionArgs.rowId;
			var parentFolderId = eActionArgs.rowItemId;
			var phantomGroupRowId = null;
			if (eActionArgs.isPhantomRow) {
				phantomGroupRowId=rowId;
				rowId=eActionArgs.gridHandler.grid.getParentId(rowId);
				parentFolderId = eActionArgs.gridHandler.getGridRowUserData(rowId, "rowItemID");
			}
			if (!rowId) {top.aras.AlertError(top.aras.getResource("ItemFolders", "itemfoldertreegrid.message.error_getting_parent_of_grid_row")); return false;}

			// Create new SubFolder Rel and new Folder Item (is NULL relationship)
			var folderItemRel = top.aras.newIOMItem("cFolder URL","add");
			folderItemRel.setProperty("source_id", parentFolderId);
			folderItemRel.setProperty("name",res.name);
			folderItemRel.setProperty("url",res.url);
			if (res.description && res.description !== "") {folderItemRel.setProperty("description",res.description);}
		 
			folderItemRel = folderItemRel.apply(); //add new relationship on server
			if (folderItemRel.isError()) {
				top.aras.AlertError(top.aras.getResource("ItemFolders", "itemfoldertreegrid.message.add_url_folder_error") + folderItemRel.getErrorString());
				return false;
			}

			fn_refreshGridAndShowRow (eActionArgs.gridHandler, rowId);
			return true;
		}
	};

	fn_showFormInModalDialog("cFolder Add URL", "Add New URL", eActionArgs.rowItemType, null, callback);
};
//-----------------
fn_onPromoteFoldersDown = function (eActionArgs, targetState) {
  if (eActionArgs.rowItemType !== "cFolder"){top.aras.AlertError(top.aras.getResource("ItemFolders","itemfoldertreegrid.message.action_not_valid_on_folder_rows"));return;}

  var lockStatus = fn_GetLockedStatusOfItemFromServer(eActionArgs.rowItemType, eActionArgs.rowItemId); 
  if (lockStatus > 0) {
    top.aras.AlertError(top.aras.getResource("ItemFolders", "itemfoldertreegrid.message.folder_locked_by_you_or_other_please_unlock"));
    return;
  }

  if (targetState === "Archived"){if(!top.aras.confirm(top.aras.getResource("ItemFolders", "itemfoldertreegrid.message.confirm_promote_to_archived"))){return;}}
  if (targetState === "Active")  {if(!top.aras.confirm(top.aras.getResource("ItemFolders", "itemfoldertreegrid.message.confirm_promote_to_active"))){return;}}
  if (targetState === "Released")  {if(!top.aras.confirm(top.aras.getResource("ItemFolders", "itemfoldertreegrid.message.confirm_promote_to_released"))){return;}}

  var argsItem = innovator.newItem(eActionArgs.rowItemType,"get");
  argsItem.setAttribute("select","id,name,state,owned_by_id,managed_by_id,team_id");
  argsItem.setID(eActionArgs.rowItemId);
  argsItem = argsItem.apply();

  var folderCurState = argsItem.getProperty("state","");
  if (folderCurState === targetState) {
    top.aras.AlertError(top.aras.getResource("ItemFolders", "itemfoldertreegrid.message.folder_already_in_status_x")+targetState+" !");
    return;
  }
  if (targetState === "Active" && folderCurState !== "Planning") {
    top.aras.AlertError(top.aras.getResource("ItemFolders", "itemfoldertreegrid.message.folder_must_be_in_status_planning"));
    return;
  }
  if (targetState === "Released" && folderCurState !== "Planning") {
    top.aras.AlertError(top.aras.getResource("ItemFolders", "itemfoldertreegrid.message.folder_must_be_in_status_planning"));
    return;
  }
  if (targetState === "Archived" && folderCurState !== "Active") {
    top.aras.AlertError(top.aras.getResource("ItemFolders", "itemfoldertreegrid.message.folder_must_be_in_status_active"));
    return;
  }

  argsItem.setProperty("state",targetState); // state to promote to
  top.aras.evalMethod ("cFolders Promote DownA",argsItem.dom.xml);
  
  eActionArgs.gridHandler.gridRefresh(true);
  return;
};
//-----------------
fn_onExpandSubFolders = function (grid, childIds) {
	//remove rows from grid
	for (var i=0; i<childIds.length && childIds[0] !== ""; i++) {
		grid.openItem(childIds[i]);
	}	
	for (i=0; i<childIds.length; i++) {
		fn_onExpandSubFolders(grid,grid.getChildItemsId(childIds[i], true, "|").split("|"));
	}	
};

//^^^^^ Custom menu actions

//--- helper ------

fn_refreshGridAndShowRow = function (gridHandler, rowId) {
	gridHandler.gridRefresh(true);
	//top.aras.AlertSuccess(top.aras.getResource("CommonUtilities","commonUtilities.message.refreh_grid_to_see_results"));
		
	// expand folder to see new row
	setTimeout(function(){
	try {
		} finally {
			gridHandler.grid.requestFocus();
			gridHandler.grid.showRow(rowId);
			gridHandler.grid.openItem(rowId);
	}} , 10);
};

fn_getValidFolderRowId = function (eActionArgs) {
	var rowId = eActionArgs.rowId;
	if (eActionArgs.isPhantomRow) {
		rowId = eActionArgs.gridHandler.grid.getParentId(rowId);
	}
	return rowId;
};

//-----------------
fn_onDeleteFolderRelatedItem = function (eActionArgs, relshipName, isNullRel, confirmMsg, isDeleteRelatedItem, isDeleteWhereUsedFirst) {
	if (!top.aras.confirm(confirmMsg)) {return;}
	if (!isDeleteWhereUsedFirst || isDeleteWhereUsedFirst === undefined) {isDeleteWhereUsedFirst = false;}
	if (isDeleteRelatedItem && isDeleteWhereUsedFirst) {
		//call Server Method to handle the delete (will also delete relationships to all cFolders with this item)
		var itm = innovator.getItemById(eActionArgs.rowItemType, eActionArgs.rowItemId);
		if (itm) {
			itm.setAttribute("checkWhereUsed","1");  // 
			var check = itm.apply("Del RelatedItem in All cFolders");
			if (check.getItemCount() > 1) {
				if (!top.aras.confirm(top.aras.getResource("ItemFolders", "itemfoldertreegrid.message.confirm_delete_ctrld_item_and_remove_from_other_folders"))) {return;}
			}
			itm.removeAttribute("checkWhereUsed");
			itm = itm.apply("Del RelatedItem in All cFolders");
			if (itm.isError()) {top.aras.AlertError(top.aras.getResource("ItemFolders", "itemfoldertreegrid.message.cannot_delete_ctrld_item")+itm.getErrorString() ); return;}
			
			// remove folder from grid (delete row)
			eActionArgs.gridHandler.grid.deleteRow(eActionArgs.rowId);
		}
		return;
	}
		
	// get relationship to parent folder and then delete it
	var parentFolderRowId = eActionArgs.gridHandler.grid.getParentId(eActionArgs.rowId);
	if (eActionArgs.gridHandler.getGridRowUserData(parentFolderRowId,"isPhantomRow") === "1") {
		parentFolderRowId = eActionArgs.gridHandler.grid.getParentId(parentFolderRowId);  // go up one more level
	}
  
	var parentFolderId = eActionArgs.gridHandler.getGridRowUserData(parentFolderRowId,"rowItemID");
	var delCmd = top.aras.newIOMItem("");

	var relId;
	if (isNullRel) {
		relId = eActionArgs.rowItemId;
		delCmd.loadAML("<Item type='"+relshipName+"' action='delete' id='"+relId+"' />");
		delCmd = delCmd.apply();
		if (delCmd.isError()) {top.aras.AlertError(top.aras.getResource("ItemFolders", "itemfoldertreegrid.message.cannot_delete_relationship_to_parent_folder")+delCmd.getErrorString() ); return;}
	}
	else {
		delCmd.loadAML("<Item type='"+relshipName+"' action='get' ><source_id>"+parentFolderId+"</source_id><related_id>"+eActionArgs.rowItemId+"</related_id></Item>");
		delCmd = delCmd.apply();
		if (delCmd.isError()) {top.aras.AlertError(top.aras.getResource("ItemFolders", "itemfoldertreegrid.message.cannot_delete_relationship_to_parent_folder")+delCmd.getErrorString() ); return;}
		for (var i=0;i<delCmd.getItemCount();i++) { 
			relId = delCmd.getItemByIndex(i).getID();
			delCmd.loadAML("<Item type='"+relshipName+"' action='delete' id='"+relId+"' />");
			delCmd = delCmd.apply();
			if (delCmd.isError()) {top.aras.AlertError(top.aras.getResource("ItemFolders", "itemfoldertreegrid.message.cannot_delete_relationship_to_parent_folder")+delCmd.getErrorString() ); return;}
		}
	}
	// remove folder from grid (delete row)
	eActionArgs.gridHandler.grid.deleteRow(eActionArgs.rowId);

	// now delete the related item, as well
	if (isDeleteRelatedItem && !isNullRel) {
		delCmd.loadAML("<Item type='"+eActionArgs.rowItemType+"' action='delete' id='"+eActionArgs.rowItemId+"' />");
		delCmd = delCmd.apply(a);
		if (delCmd.isError()) {top.aras.AlertError(top.aras.getResource("ItemFolders", "itemfoldertreegrid.message.cannot_delete_ctrld_item")+delCmd.getErrorString() ); return;}
		//if (delCmd.isError()) {top.aras.AlertError("Cannot delete item ("+eActionArgs.rowItemType+") - "+delCmd.getErrorString() ); return;}
	}
};

//---------------
fn_checkCurrentUserIsOwnerOfThisItem = function (itemType, itemId) {
  // returns item error if user is not owner !
  var checkItem = top.aras.newIOMItem(itemType,"get");
  checkItem.setID(itemId);
  return top.aras.evalMethod ("IsUser Member Of ItemOwner",checkItem.dom.xml);
};

]]></method_code>
  <method_type>JavaScript</method_type>
  <name>cFolder Struct GridMenu Handler</name>
 </Item>
</AML>