<AML>
 <Item type="Method" id="FB13EB8D63774DB294E7A147527CB220" action="add">
  <comments>handles a treeGrid defined by configuration - Clone it, if you need addtional logic</comments>
  <execution_allowed_to keyed_name="World" type="Identity">A73B655731924CD0B027E4F4D5FCC0A9</execution_allowed_to>
  <method_code><![CDATA[// =======================================================
// JavaScript Method to "handle" display of structure node and structure relationships configured
//
// Depends on methods: (that must be loaded first !!!)
//   "BaseGridMain Utilities"
//   "BaseGridRow Utilities"
//   "BaseGridMenu Utilities"
//   "CommonBase TreeGridCfg Handler"
//   "cFolder Struct GridMenu Handler"
//  
// The toolbar, grid layout, and grid context menus are defined by a separate configuration module.
//
// If you want to create your own specialized grid handling logic, you can CLONE this JS method and then
// modify its logic to be used instead of this JS method
//
// Rolf Laudenbach
// 2015
// Dec 2016 - added reloading onClick
// =======================================================

// load --> JS libraries from Innovator code tree (Client/Solutions)
// (previous versions had these loaded as methods with the form !!!) --> outdated old method names: "CommonBase GridUtiltities", "CommonBase GridConfiguration"
if (typeof BaseGrid != 'function') {eval(top.aras.getFileText(top.aras.getBaseURL() + "/Solutions/CommonUtilities/javascript/BaseGridMain_Utiltities.js"));}
if (typeof RowClass != 'function') {eval(top.aras.getFileText(top.aras.getBaseURL() + "/Solutions/CommonUtilities/javascript/BaseGridRow_Utiltities.js"));}
if (typeof BaseMenuActionHandler != 'function') {eval(top.aras.getFileText(top.aras.getBaseURL() + "/Solutions/CommonUtilities/javascript/BaseGridMenu_Utiltities.js"));}
if (typeof TreeGridConfiguration != 'function') {eval(top.aras.getFileText(top.aras.getBaseURL() + "/Solutions/CommonUtilities/javascript/CommonBaseTreeGridCfgHandler.js"));}

// load with --> onLoad Event on Form:
var isStartedFromTab = false;
if (top.relationships && typeof(top.relationships) !== undefined) {isStartedFromTab=true;}
var isStartedFromTOCview = false;
var isGetRootItemByConfigRule = false;
var topItemType = "";
var grid;

// callback from method "ForceGridRefreshOnRelTabs - so topItem's populate event also results in a refresh of the grid"
window.forceGridRefreshOnRelationship = function(relshipTypeName) {
	if (!isStartedFromTab) {return;}

	if (this.showDebugAlerts) {alert("apply forced refresh to relationship tab='"+relshipTypeName+"'");}

	//if this relationship name is registered in config constant "itemTabRelShipNames", then fire refresh action.
	var confTabRels = top.TreeGridHandler.CONFIG.getValue("itemTabRelShipNames");
	if (confTabRels && confTabRels !== "" && confTabRels.indexOf(relshipTypeName) >= 0) {
		top.TreeGridHandler.refreshGridWithTimout(true);
	}
};

treeGridHandlerClass = function treeGridHandlerClassFunc() { // grid class instantiation
	this.gridLayoutInitialized = false;
    this.initialized = false;
};
treeGridHandlerClass.prototype = new BaseGrid(); // adding base class from common grid utilities

treeGridHandlerClass.prototype.setGridConfiguration = function treeGridHandlerClass_setGridConfiguration(configContext) {
  this.CONFIG = configContext;
};
treeGridHandlerClass.prototype.setMenuActionHandler = function treeGridHandlerClass_setMenuActionHandler(baseMenuActionHandler) {
	this.baseMenuActionHandler = baseMenuActionHandler;
};
treeGridHandlerClass.prototype.setCustomMenuActionHandler = function treeGridHandlerClass_setCustomMenuActionHandler(customMenuActionHandler) {
	this.baseMenuActionHandler.setCustomMenuActionHandler(customMenuActionHandler);
};

treeGridHandlerClass.prototype.initGridLayout = function treeGridHandlerClass_initGridLayout() {
    //load mappings of properties to columns (of different row types)
	if (!this.structureRelName) {return false;}

	//determine grid view to use
	this.viewName = "default";
	//debugger;
	this.structItemBgColor = this.CONFIG.getGridStructureRowBgColor();
	this.RootRowBgColor = this.CONFIG.getValue("rootRowsBgColor");
	
	this.disallowDuplicateStructureItems = this.CONFIG.isDisallowDuplicateItems();
	this.showStructureOnly = false;

	if (!this.CONFIG.viewConfigExists(this.viewName)) 
	  {top.aras.AlertError(top.aras.getResource("CommonUtilities","commonUtilities.message.config_of_grid_view_x_does_not_exist").format(this.viewName));return false;}

	this.gridEmptyTable_xml = this.CONFIG.getGridDefinitionXml(this.viewName, false, this.hasInputRow); //reads prop mappings and rel menu actions

	this.gridVisibleColumns = this.CONFIG.visibleGridColumns;
	this.gridContextMenu = this.CONFIG.getAllMenuActions(this.viewName);
	this.numberOfGridColumns = this.CONFIG.getNumberOfVisibleColumns();
	this.lockIconColumnNo = this.CONFIG.lockColumnIndex;

 
	this.grid.InitXml(this.gridEmptyTable_xml);
	grid = this.grid;
	
	this.gridLayoutInitialized = true;
	return true;
};

treeGridHandlerClass.prototype.onBeforeInitialize = function treeGridHandlerClass_onBeforeInitialize() {
    this.topItemId = "undefined";
    this.topItem = null;

	this.isStartedFromTOCview = isStartedFromTOCview;
	this.isStartedFromTab = isStartedFromTab;
	
	this.numberOfGridColumns=-1; //init
    this.structItemBgColor = "";
	this.RootRowBgColor = "";
	
	this.structureNodeTypeName = this.CONFIG.getGridStructureNodeName();
	this.structureRootItemId = "undefined";
	this.structureRelName = this.CONFIG.getGridStructureRelShipName();
	
		//maximize
	if (!isStartedFromTab && this.CONFIG.getValue("maximizeWindowIfNotOnTab") === "true") {
		top.window.moveTo(0,0); top.window.resizeTo(screen.width,screen.height);
	}
    this.hasInputRow = (this.CONFIG.getValue("hasInputRow") === "true");
    this.showDebugAlerts = (this.CONFIG.getValue("showDebugAlerts") === "true");
    this.isExpandRootRowsOnStart = (this.CONFIG.getValue("isExpandRootRowsOnStart") === "true");
};

treeGridHandlerClass.prototype.initialize = function treeGridHandlerClass_Initialize() {
	this.onBeforeInitialize();
	this.ignoreToolbarChangeEvent = true; // !!! this must be set to avoid unnecessary toolbar change event during initialization

	this.searchText = "";
	this.eActionArgs = null;
	this.relatedProjectKN = "";
	this.inputRowTdVals = null;
	this.gridData_AML= [];
    this.IsExpandOnStart = false;
	this.levelsToLoad = "*";  // "0"= root levels only,  "*"= all levels
	this.rootRowToRefresh = -1;
	
	// create grid control
	this.grid = this.loadTreeGridIntoHtmlElement("grid1"); // pass the id of the html element on this form
	// toolbar control
	this.toolbar = this.loadToolbarIntoHtmlElement("toolbar1"); // pass the id of the html element on this form
	this.hasToolbar = true;  // grid could be loaded without toolbar
	
	if (this.hasToolbar) {
		this.showToolbarLabels = (top.aras.getVariable('ShowLabels') == 'true');

		var xml = this.CONFIG.getToolbarXML();

		if (this.arasUseOldDojoPath) {this.toolbar.LoadToolbarFromStr(xml);}
		else {this.toolbar.loadToolbarFromStr(xml);}
		this.toolbar.show();
		
	}
	// init choice settings on toolbar
	this.setChoiceSelectionOnToolbar("relation_ship_filter", this.CONFIG.getValue("relationshipFilterStartup")); // will fire toolbar change event
    this.fixEffectivityToReleased = false; // defines startup effectivity mode
	this.setChoiceSelectionOnToolbar("effectivity_mode", "current_config"); // will fire toolbar change event

	this.initialized = true;
	if (this.showDebugAlerts) {alert("grid is initialized");}

	this.gridRefresh(true);  //refresh with load=true will come later from "forceRefreh" method of form's onPopulate even
};

treeGridHandlerClass.prototype.defineTopItemContext = function treeGridHandlerClass_defineTopItemContext() {
  //debugger;
  this.structureRootItemId = "undefined";
  this.gridIsEditable = false;
  this.currentUserIsOwnerOfTopItem = false;
  this.currentUserIsManagerOfTopItem = false;
  
  // root item to start with is defined by grid configuration of top item's item type
  if (this.CONFIG.rootItemConfigId && this.CONFIG.rootItemConfigId !== "") { 
	var rootItem = null;
	if (this.CONFIG.rootItemConfigId.indexOf("root:") >=0) {
		var val = this.CONFIG.rootItemConfigId.replace(/ /g,"");
		if (val.indexOf("*") > 0) {
			this.structureRootItemId = "*";
			isGetRootItemByConfigRule = true;
			return;
		}
		if (val.indexOf("owner") > 0) {
			this.structureRootItemId = "owner";
			isGetRootItemByConfigRule = true;
			return;
		}
	}
	if (!rootItem) {
		rootItem = fn_getItemByConfigId(this.structureNodeTypeName,this.CONFIG.rootItemConfigId,this.CONFIG.rootItemGeneration,"");
		if (rootItem.isError()) 
		{top.aras.AlertError(top.aras.getResource("CommonUtilities","commonUtilities.message.cannot_load_root_item_defined_by_grid_config_rule").format(this.CONFIG.configurationName)); return;}
	}
  
  	this.structureRootItemId = rootItem.getID();
	
	if (isStartedFromTOCview) {document.thisItem = rootItem;}
  }
  
  var thisItem = document.thisItem;  //context item - can be different depending on how form was started !!!
  if (!thisItem || thisItem === undefined) 
	{top.aras.AlertError(top.aras.getResource("CommonUtilities","commonUtilities.message.form_context_item_this_item_not_set")); return;}
  this.topItem = thisItem;
  this.topItemType = thisItem.getType();
  this.topItemId = thisItem.getAttribute("id",""); 
  
  if (this.topItemType === "cFolder") {
	this.relatedProjectKN = thisItem.getProperty("related_project_keyed_name","");
  }

  // is root item to start with is linked from top item	
  if(this.CONFIG.rootItemPropertyName && this.CONFIG.rootItemPropertyName !== "") {  
	this.structureRootItemId = thisItem.getProperty(this.CONFIG.rootItemPropertyName,"undefined");
  }
  
  // is root item is the same as top item
  if (this.structureRootItemId === "undefined" && this.topItemType === this.structureNodeTypeName) {
	this.structureRootItemId = this.topItemId;
  }

  this.gridIsEditable = top.aras.isLockedByUser(thisItem.node); //if top item is locked
  this.currentUserIsOwnerOfTopItem = fn_IsCurrUserMemberOfIdentityId(this.topItem.getProperty("owned_by_id",""));	
  this.currentUserIsManagerOfTopItem = fn_IsCurrUserMemberOfIdentityId(this.topItem.getProperty("managed_by_id",""));	
  //this.currentUserIsTeamGuestOfTopItem = fn_isUserMemberOfThisItemTeamGuest(document.thisItem);   
  
  this.runServerCallbacks(this.topItem);
};

treeGridHandlerClass.prototype.runServerCallbacks = function treeGridHandlerClass_runServerCallbacks(dataItems) {
	//call Server Method "CommonBase onBefore GridDraw" with the context of the "topItem/DataItems" to allow server side callbacks, before grid starts loading data.
	if (this.CONFIG.getValue("enableServerCallbackOnBeforeGridDraw") !== "true") {return;}

	if (this.onBeforeGridDraw === undefined) {
		var methodRes = top.aras.newIOMItem(dataItems.getItemByIndex(0).getType());
		if (dataItems.getItemCount() === 1) {
			methodRes.setID(dataItems.getID());
		}
		else {
			var ids = [];
			for (var i=0; i<dataItems.getItemCount();i++) {ids.push(dataItems.getItemByIndex(i).getID());}
			methodRes.setAttribute("idsList",ids.join(","));
			methodRes.setProperty("id","'"+ids.join("','")+"'");
		}
		if (this.showDebugAlerts) {alert("calling server Method: 'CommonBase onBefore GridDraw'");}
		methodRes = methodRes.apply("CommonBase onBefore GridDraw");
		if (methodRes.isError()) {top.aras.AlertError(methodRes.getErrorString()); return;}
		this.onBeforeGridDraw = "done";
	}
};

//--------------
treeGridHandlerClass.prototype.GetGridData = function treeGridHandlerClass_GetGridData(itemType, itemId, getMultipleRootItems, levelsToLoad) {
	if (this.showDebugAlerts) {alert("Type:"+itemType+" Id:"+itemId+" isReleased:"+this.isReleasedMode+" searchText:"+this.searchText);}
	if (getMultipleRootItems === null || getMultipleRootItems === undefined) {getMultipleRootItems=false;}
	if (levelsToLoad === null || levelsToLoad === undefined) {levelsToLoad="*";}

	var resItem = top.aras.newIOMItem("","");
	var aml = "";
	if (levelsToLoad === "*"){
		aml = this.CONFIG.buildGridDataQueryAML(this.viewName, itemType, itemId, this.isReleasedMode);
	}
	else if (levelsToLoad === "0"){
		// build 1 level query as required
		aml = "<Item type='"+itemType+"' id='"+itemId+"' action='get' select='"+this.CONFIG.getGridStructureNodeItemSelect(this.viewName)+"' >";
		if (!getMultipleRootItems) {
			aml += "<Relationships>";
			aml +=   "<Item type='"+this.structureRelName+"' action='get' select='config_id,id,sort_order,related_id' >";
			aml +=    "<related_id>";
			aml +=       "<Item type='"+itemType+"' action='get' select='"+this.CONFIG.getGridStructureNodeItemSelect(this.viewName)+"' />";
			aml +=    "</related_id>";
			aml +=   "</Item>";
			aml += "</Relationships>";
			aml = aml.replace(/repeatTimes="0"/,'repeatTimes="1"');
		}
		aml += "</Item>";
	}
	else {
		aml = this.CONFIG.buildGridDataQueryAML(this.viewName, itemType, itemId, this.isReleasedMode);
		aml = aml.replace(/repeatTimes="0"/,'repeatTimes="'+levelsToLoad+'"'); 
	}

	resItem.loadAML(aml);

	if (getMultipleRootItems) {
		resItem.setAttribute("getMultipleRootItems","1");
		resItem.setAttribute("structureNodeTypeName",itemType);
		resItem.setAttribute("structureReleasedCondition",this.CONFIG.structureReleasedCondition);
		resItem.setAttribute("isReleased",this.isReleasedMode);
		if (this.structureRootItemId === "owner") {resItem.setAttribute("restrictToRootOwnerId",fn_GetAliasIdOfCurrentUser());}
	}

	var dataAction = resItem.getAttribute("action","");
	resItem.setAttribute("dataAction",dataAction);
	resItem.setAction("cFolder GetGridData");
	resItem = resItem.apply();
	return resItem;
};

//--------------
treeGridHandlerClass.prototype.GetGridDataSearch = function treeGridHandlerClass_GetGridDataSearch(itemType, itemId, getMultipleRootItems) {
	if (this.showDebugAlerts) {alert("Type:"+itemType+" Id:"+itemId+" isReleased:"+this.isReleasedMode+" searchText:"+this.searchText);}
	if (!getMultipleRootItems || getMultipleRootItems === undefined) {getMultipleRootItems=false;}

	var resItem = top.aras.newIOMItem("","");
	var aml = this.CONFIG.buildGridDataQueryAML(this.viewName, itemType, itemId, this.isReleasedMode);
	resItem.loadAML(aml);

	if (getMultipleRootItems) {
		resItem.setAttribute("getMultipleRootItems","1");
		resItem.setAttribute("structureNodeTypeName",itemType);
		resItem.setAttribute("structureReleasedCondition",this.CONFIG.structureReleasedCondition);
		resItem.setAttribute("isReleased",this.isReleasedMode);
		if (this.structureRootItemId === "owner") {resItem.setAttribute("restrictToRootOwnerId",fn_GetAliasIdOfCurrentUser());}
	}
	if (this.searchText !== "") {
		resItem.setAttribute("searchText",this.searchText);
		resItem.setAttribute("searchWithinProjectKN",this.relatedProjectKN);
	}
	
	var structureNodeRelNames = ""; var sep = "";
	for (var relQueryName in this.structureRowRelDefinitions) {
		structureNodeRelNames += sep + this.structureRowRelDefinitions[relQueryName].relationshipName;
		sep = ",";
	}
	resItem.setAttribute("structureNodeRelNames",structureNodeRelNames);

	var dataAction = resItem.getAttribute("action","");
	resItem.setAttribute("dataAction",dataAction);
	resItem.setAction("cFolder GetGridData Search");
	resItem = resItem.apply();

	// Expand any truncated branches
	var itemsToCorrect = resItem.getItemsByXPath("//Item[related_id[not(Item)]]");
	for (var i=0; i<itemsToCorrect.getItemCount() && loadFullStructure===true; i++)
	{
		var tmpItem = itemsToCorrect.getItemByIndex(i);
		tmpItem.setRelatedItem(resItem.getItemsByXPath("//Item[@id='"+tmpItem.getProperty("related_id")+"']").getItemByIndex(0));
	}	
	return resItem;
};

// +++++ Draw grid contents +++++
treeGridHandlerClass.prototype.Draw = function treeGridHandlerClass_Draw(isReLoad) {
	if (this.hasInputRow) {this.grid.showInputRow(true);}

	if (this.showDebugAlerts) {alert("draw with reload='"+isReLoad+"'");}
	// get data from server
	if (isReLoad) {
		this.rootRowToRefresh = -1;
	
		//alert("reLoad");
		// re-set variables related to top/root item
		this.defineTopItemContext();
		if (this.showDebugAlerts) {alert("TopItem Identified:"+this.topItemType);}

		if (!this.initGridLayout()) {return;}
		var isReleased = (this.getChoiceSelectionFromToolbar("effectivity_mode") === "latest_released");
 //debugger;
		this.isReleasedMode = isReleased;

		this.levelsToLoad = "*";
		if (isStartedFromTOCview && this.searchText === "") {
			this.levelsToLoad = "0";
		}		
		var itm;
		this.gridData_AML = [];  // reset
		var rootDataItems,i;

		if (!isGetRootItemByConfigRule) {
			if (isReleased === true) {
				itm = top.aras.newIOMItem(this.structureNodeTypeName);
				itm.setAttribute("id",this.structureRootItemId);
				itm = itm.apply("Get ItemID of Released Gen");
				if (itm.isError()) {
					this.grid.removeAllRows();
					top.aras.AlertError(top.aras.getResource("CommonUtilities","commonUtilities.message.root_item_has_no_released_gen_set_eff_to_current")); return;
				}
				this.structureRootItemId = itm.getProperty("id");
			}
			if (this.searchText !== "") {
				rootDataItems = this.GetGridDataSearch(this.structureNodeTypeName,this.structureRootItemId, false);
				// search results are from GetGridData are flat list of folders !!!
				for (i=0; i<rootDataItems.getItemCount(); i++) {
					this.gridData_AML[i] = rootDataItems.getItemByIndex(i);
				}
			}
			else {
				rootDataItems = this.GetGridData(this.structureNodeTypeName,this.structureRootItemId, false, this.levelsToLoad);
				this.gridData_AML[0] = rootDataItems;
				if (this.gridData_AML[0].getItemCount() === 0) {return;} // do nothing 
				if (this.gridData_AML[0].isError()) {top.areas.AlertError(this.gridData_AML[0].getErrorString()); return;} // do nothing 
			}
		}
		else {
			if (this.searchText !== "") {
				rootDataItems = this.GetGridDataSearch(this.structureNodeTypeName,this.structureRootItemId, isStartedFromTOCview);
			}
			else {
				rootDataItems = this.GetGridData(this.structureNodeTypeName,this.structureRootItemId, isStartedFromTOCview, this.levelsToLoad); 
			}
			for (i=0; i<rootDataItems.getItemCount(); i++) {
				this.gridData_AML[i] = rootDataItems.getItemByIndex(i);
			}
		}
	}
    // draw data into grid
	this.DrawGridContent(this.gridData_AML);
};

treeGridHandlerClass.prototype.DrawGridContent = function treeGridHandlerClass_DrawGridContent(dataItemsArray, keepGridContents, drawChildrenOfThisRowId, reDrawChildren) {
	if (!this.gridLayoutInitialized) {return;} //initGridLayout did not complete all settings - wait for next Draw event.
//debugger;
    if (dataItemsArray.length === 0) {return;}  //cannot draw, if XML is null
	if (drawChildrenOfThisRowId === null || drawChildrenOfThisRowId === undefined) {drawChildrenOfThisRowId = "";}
	if (reDrawChildren === null || reDrawChildren === undefined) {reDrawChildren = false;}
	if (keepGridContents === null || keepGridContents === undefined) {keepGridContents = false;}
	if (this.rootRowToRefresh >= 0) {keepGridContents = true;}

	// determine current relationship filter setting
	this.showStructureOnly = false;
	this.showRelShipsFilter = "ALL";

	var tbRelShipFilter = this.getChoiceSelectionFromToolbar("relation_ship_filter");
	if (tbRelShipFilter && tbRelShipFilter !== undefined) {
		switch(tbRelShipFilter)
		{
		case "show_structure_only":
			this.showStructureOnly = true;
			break;
		default:
			this.showStructureOnly = false;
			this.showRelShipsFilter = tbRelShipFilter;
		}
	}
	
	if (!keepGridContents) {
		this.grid.removeAllRows();
		this.clearGridRowUserData(); //clear gridUserData of all registered rows
		this.structureRowRelDefinitions = this.CONFIG.getGridStructureRowRelShipDefinitions(this.viewName);
		this.relShipColumnMappings = this.CONFIG.relshipColumnMappings;	
	}
	var rowConfig = {};
	
	// loop over all retrieved root items - and resolve their structure
	for (var d=0; d<dataItemsArray.length; d++) {
		var rootItem = dataItemsArray[d];
		if (rootItem.isError()) {return;} // no data found
		
		this.runServerCallbacks(rootItem);
		
		var doDrawRows = true;
		var parents;
		var rowId;
    	rowConfig.isApplyChildBgColorUpToRoot = this.CONFIG.isApplyChildBgColorUpToRoot();
		rowConfig.rowIcon = this.CONFIG.getGridStructureRowIcon();
		rowConfig.bgColorOfStructItemWithChildren = this.CONFIG.getBgColorOfStructItemWithChildren();
		rowConfig.doNotColorRootRows = !this.isStartedFromTOCview;

		if (this.showStructureOnly === true) {rowConfig.rowBgColor = "";}
		
		if (drawChildrenOfThisRowId !== "" && dataItemsArray.length == 1) {
			rowId = drawChildrenOfThisRowId;
			rowConfig.rowBgColor = this.structItemBgColor;
			
			//debugger;  var childIds = this.grid.getChildItemsId(rowId, true, "|");
			
			var parentItemID = this.getGridRowUserData(this.grid.getParentId(rowId),"rowItemID");;
			var parentItemConfigId = this.getGridRowUserData(this.grid.getParentId(rowId),"rowItemConfigId");;
			if (parentItemID === undefined) {parentItemID = null;}
			if (parentItemConfigId === undefined) {parentItemConfigId = null;}
			this.DrawStructureRowRelationshipsGroups(this.structureRelName, parentItemID, parentItemConfigId, rootItem, rowId, rowConfig); //"BaseGridMain Utilities" function
			
			if (reDrawChildren) {
				parents = {}; //needed for recursive calls to resolve multi-level children of structure
				this.DrawStructureRowChildren(this.structureRelName, rootItem, rootItem.getProperty("config_id",""), rowId, parents, rowConfig); //"BaseGridMain Utilities" function
			}
		}
		else {
		 if (isStartedFromTOCview && !isGetRootItemByConfigRule && this.searchText === "" && !keepGridContents) {
			// do not show root folder in grid (but first level sub folders)
			rowConfig.rowBgColor = this.structItemBgColor;
			var firstLevelItems = rootItem.getRelationships(this.structureRelName);
			if (this.showStructureOnly === true) {rowConfig.rowBgColor = "";}
		
			for (var c=0; c<firstLevelItems.getItemCount(); c++) {
				rootItem = firstLevelItems.getItemByIndex(c).getPropertyItem("related_id");
				
				if (this.rootRowToRefresh >= 0) {
					if (this.rootRowToRefresh !== c) {doDrawRows = false;}
					else {doDrawRows = true;}
				}

				if (rootItem && doDrawRows) {
					rowId = this.DrawStructureRow (this.structureRelName, rootItem, firstLevelItems.getItemByIndex(c), null, null, rowConfig);  //"BaseGridMain Utilities" function
					if (this.levelsToLoad  === "0" && this.rootRowToRefresh < 0 ) {
						// set folder icon to indicate that more level can be reloaded
						this.grid.setRowIcons(rowId, "../images/cFolderReloadNode.svg", "../images/cFolderReloadNode.svg");
						this.setGridRowUserData(rowId, "reloadNextLevels", "1");
					}
					this.setGridRowUserData(rowId,"rootRowDataIndex",c);
					if (this.showDebugAlerts) {alert("grid root row added.");}
					parents = {}; //needed for recursive calls to resolve multi-level children of structure
					this.DrawStructureRowChildren(this.structureRelName, rootItem, rootItem.getProperty("config_id",""), rowId, parents, rowConfig); //"BaseGridMain Utilities" function
				}
			}
		 }
		 else {
			// show root item in grid
			rowConfig.rowBgColor = this.RootRowBgColor;
			if (isGetRootItemByConfigRule || this.searchText !== "") {
			    rowConfig.rowBgColor = this.structItemBgColor;
			}
			if (this.searchText !== "" && rootItem.getAttribute("cFolderChildrenHaveSearchResult","0") === "1") {
			    rowConfig.rowBgColor = this.RootRowBgColor;
       			rowConfig.doNotColorRootRows = true;
			}
			if (this.rootRowToRefresh >= 0) {
				if (this.rootRowToRefresh !== d) {doDrawRows = false;}
				else {doDrawRows = true;}
			}
			if (rootItem && doDrawRows) {
				rowId = this.DrawStructureRootRow(this.structureRelName, rootItem, rowConfig); //"BaseGridMain Utilities" function
				if (this.levelsToLoad === "0" && this.rootRowToRefresh < 0) {
					// set folder icon to indicate that more level can be reloaded
					this.grid.setRowIcons(rowId, "../images/cFolderReloadNode.svg", "../images/cFolderReloadNode.svg");
					this.setGridRowUserData(rowId, "reloadNextLevels", "1");
				}
				this.setGridRowUserData(rowId,"rootRowDataIndex",d);
				if (this.showDebugAlerts) {alert("grid root row added.");}

				rowConfig.rowBgColor = this.structItemBgColor;
				if (this.showStructureOnly === true) {rowConfig.rowBgColor = "";}
				parents = {}; //needed for recursive calls to resolve multi-level children of structure

				this.DrawStructureRowChildren(this.structureRelName, rootItem, rootItem.getProperty("config_id",""), rowId, parents, rowConfig); //"BaseGridMain Utilities" function
			}
		 }
		}
	}
	
	this.rootRowToRefresh = -1; // reset
	
	// determine whether to expand root row or not ?
	if (!isGetRootItemByConfigRule) {
	  if (this.isExpandRootRowsOnStart && !isStartedFromTOCview || isGetRootItemByConfigRule) {
		// need a timeout before openItem can be called. 	  
		var self = this;
		setTimeout(function(){
		try {
			} finally {
				self.grid.openItem(rowId); //Root Item
		}} , 200);
	  }
	}
	return;
};

treeGridHandlerClass.prototype.ReDrawStructureRowValues = function treeGridHandlerClass_ReDrawStructureRowValues(rowId, structureRowItem) {
	if (structureRowItem === undefined || structureRowItem === null) {
		// fetch the structrue item
		structureRowItem = innovator.getItemById(this.getGridRowUserData(rowId,"rowItemType"), this.getGridRowUserData(rowId,"rowItemID"));
	}
	this.UpdateStructureRowValues(this.structureRelName, rowId, structureRowItem, null);
};

treeGridHandlerClass.prototype.ReloadAndDrawThisStructureRow = function treeGridHandlerClass_ReloadAndDrawThisStructureRow(rowId, reloadChildren) {
	var structureItemId = this.getGridRowUserData(rowId,"rowItemID");

	// reload data of this structure item
	this.grid.setRowIcons(eArg.rowId, "../images/cFolderReloading.svg", "../images/cFolderReloading.svg");
	this.grid.enable();
	var self = this;
	setTimeout(function(){
	try {
		} finally {
		var dataItems = [];
		levelsToLoad = "*";
		if (!reloadChildren) {levelsToLoad = "2";}// get same and next level of folder structure only
		dataItems[0] = self.GetGridData(self.structureNodeTypeName, structureItemId, false, levelsToLoad);  
		self.grid.setPaintEnabled(false);
		self.DrawGridContent(dataItems, true, rowId, reloadChildren);
		self.grid.setPaintEnabled(true);
		self.grid.enable();
		self.grid.openItem(rowId);
	}} , 50);
};

// ^^^^^^ Draw grid contents ^^^^^^

treeGridHandlerClass.prototype.SetIsDirtyAndUpdateAction = function treeGridHandlerClass_SetIsDirtyAndUpdateAction(item) {
	//+++ set action update if action is null
	var ancestorAndSelf = item.selectNodes("ancestor-or-self::Item");
	for (var i = 0; i < ancestorAndSelf.length; i++) {
		var itemNode = ancestorAndSelf[i];
		itemNode.setAttribute("isDirty", "1");
		if(!itemNode.getAttribute("action")) {
			itemNode.setAttribute("action", "update");
		}
	}
};

treeGridHandlerClass.prototype.onBeginEditCell = function treeGridHandlerClass_onBeginEditCell(eArg) {
	var cellRowID = eArg.rowId;
	var cellColIndex = eArg.column;
	//debugger;

	if (cellRowID=="input_row") {
	  if (!this.gridVisibleColumns[cellColIndex].colFilterEdit || this.gridVisibleColumns[cellColIndex].colFilterEdit === "noedit")
        {return false;}
      else
        {return true;}
    }
	
	if(!this.gridIsEditable) {
		return false;
	}

	if (this.gridVisibleColumns[cellColIndex].colEditType && this.gridVisibleColumns[cellColIndex].colEditType !== "noedit")
       {return true;}

	// add more logic with conditions when a cell should be editable here ...  return true, if selected cell should be editable
	   
};

treeGridHandlerClass.prototype.onEndEditCell = function treeGridHandlerClass_onEndEditCell(eArg) {
	var cellRowID = eArg.rowId;
	var cellColIndex = eArg.column;

    // special handling for input row (execute filtering)
	if (cellRowID=="input_row") {
		var filters = this.getInputRowVals();
    }

	// add logic to trigger actions after edit cell has finished here ...
	
	return;
};

treeGridHandlerClass.prototype.initActionArgs = function treeGridHandlerClass_initActionArgs(eActionArgs,selectedId) {
	if (selectedId && selectedId !== undefined) {
		eActionArgs.rowId = selectedId;
		eActionArgs.rowItemType = this.getGridRowUserData(selectedId,"rowItemType");
		eActionArgs.rowItemId = this.getGridRowUserData(selectedId,"rowItemID");
		eActionArgs.rowOfGroupName = this.getGridRowUserData(selectedId,"rowOfGroupName");
		eActionArgs.isPhantomRow = (this.getGridRowUserData(selectedId,"isPhantomRow") === "1");	
	}
	eActionArgs.gridHandler = this;
	eActionArgs.gridIsEditable = this.gridIsEditable;
	eActionArgs.userIsOwnerOfContextItem = this.currentUserIsOwnerOfTopItem;
	eActionArgs.isStartedFromTab = isStartedFromTab;
	eActionArgs.effectivityMode =  this.getChoiceSelectionFromToolbar("effectivity_mode");
};

treeGridHandlerClass.prototype.gridRefresh = function treeGridHandlerClass_gridRefresh(isReLoad) {
	var self = this;
	if (self.hasToolbar) {self.enableToolbar(false);}
	self.grid.setPaintEnabled(false);

	document.getElementById(this.grid.connectId).style.visibility = 'hidden';
	document.getElementById('grid_loadingInProgress').style.visibility = 'visible';

	setTimeout(function(){
		try {
			var gridState = self.GetGridState();
			self.Draw(isReLoad);
			self.SetGridState(gridState);
			setTimeout(function()
			{
				self.SetGridState(gridState);
				if (typeof self.IsExpandOnStart === "boolean") {
					if (self.IsExpandOnStart) {self.grid.expandAll();}
					else {self.grid.collapseAll();}
					delete self.IsExpandOnStart;
				}
			},0);
		} finally {
			document.getElementById('grid_loadingInProgress').style.visibility = 'hidden';
			document.getElementById(self.grid.connectId).style.visibility = 'visible';
			self.grid.setPaintEnabled(true);
			if (self.hasToolbar) {self.enableToolbar(true);}
		}
	} ,0);

};

treeGridHandlerClass.prototype.refreshGridWithTimout = function treeGridHandlerClass_refreshGridWithTimout(isReload) {
	//If Refresh will be called multiple times per one execution scope then postponned call of Refresh_Impl will be canceled and initiated new call
	//That is mean that Refresh_Impl will be called once.
	if(this.Refresh_Impl_timeout) {
		clearTimeout(this.Refresh_Impl_timeout);
		delete this.Refresh_Impl_timeout;
	}
	var self = this;
	//Need setTimeout because during handling OnPopulated event document.thisItem contain old item and it will be refreshed after OnPopulated event
	this.Refresh_Impl_timeout = setTimeout(function () {
		self.gridRefresh(isReload);
	}, 30);
};

//+++++  BEGIN Toolbar's custom handlers
treeGridHandlerClass.prototype.enableToolbar = function treeGridHandlerClass_enableToolbar(enableToolbarElements) {
	if (!this.fixEffectivityToReleased && this.fixEffectivityToReleased === undefined) {this.fixEffectivityToReleased = false;}
	
	for (var toolbarElement in this.CONFIG.getToolbarElements()) {
		fn_enableToolbarElement(this.toolbar, toolbarElement, enableToolbarElements, false);
		
		if (this.fixEffectivityToReleased && toolbarElement.indexOf("effectivity_") >= 0) {
			fn_enableToolbarElement(this.toolbar, toolbarElement, false, false);  // force to be disabled
		}
	}
	if (enableToolbarElements) {this.ignoreToolbarChangeEvent = false;}
	else {this.ignoreToolbarChangeEvent = true;}
	
	this.toolbar.showLabels(this.showToolbarLabels);
};

treeGridHandlerClass.prototype.onToolbarClick = function treeGridHandlerClass_onToolbarClick(eArg) {
	if (this.initialized === false) {return;}
	var actionId = eArg.id;
	var coreToolbarAction = true;
	
    // add toolbar actions here ...	
	switch(actionId)
	{
		case "expand_all":
			this.expandAll(true);
			break;
		case "collapse_all":
			this.expandAll(false);
			break;
		case "refresh_all":
			this.gridRefresh(true);
			break;
		default:
			coreToolbarAction=false;
			break;
	}
	if (coreToolbarAction) {return;}
	
	// create corresponding menu action for this toolbar action for selected row
	if (!this.baseMenuActionHandler || this.baseMenuActionHandler === undefined) {return;} // menu action handler not registered
	var menuItem = {name: actionId};  // for toolbar actions menuItem.name = actionId
	this.eActionArgs = {};
	var selectedId = this.grid.getSelectedID(); //selected grid row
	this.initActionArgs(this.eActionArgs, selectedId);
	this.baseMenuActionHandler.updateActionContextArgsForRowId(this.eActionArgs, selectedId);
	eActionArgs.actionSource = "toolbar";

	var checkMsg = this.baseMenuActionHandler.executeAction(eActionArgs, menuItem);  
	if (checkMsg !== "") {top.aras.AlertError(checkMsg); return;}
};

treeGridHandlerClass.prototype.onToolbarChange = function treeGridHandlerClass_onToolbarChange(eArg) {
    if (this.ignoreToolbarChangeEvent === true) {return;}
	if (this.initialized === false) {return;}

	var id = eArg.id;
	var doInitLayout = false;
	var doRefresh = false;
	var reloadOnRefresh = false;
	
	if (id == "search_text")	{
		var txt = this.toolbar.getActiveToolbar().getElement('search_text').getText();
		this.searchText = txt; return;
	}
	if (id == "effectivity_mode")	{doRefresh=true;reloadOnRefresh=true;}
	if (id == "relation_ship_filter")  	{doInitLayout= true; doRefresh=true;reloadOnRefresh=true;}	

	if (this.showDebugAlerts) {alert("toolbar change. initLayout='"+doInitLayout+"' doRefresh='"+doRefresh+"' reloadOnRefresh='"+reloadOnRefresh+"'");}

	if (doInitLayout) {if (!this.initGridLayout()){return;}}
	if (doRefresh) {this.gridRefresh(reloadOnRefresh);}
};
//^^^^^  BEGIN Toolbar's custom handlers

// Dynamically builds the grid context menu based on select row item's context - requires menuActionHandler class !!!
treeGridHandlerClass.prototype.onGridMenuInit = function treeGridHandlerClass_onGridMenuInit(eArg) {
	if (!this.baseMenuActionHandler || this.baseMenuActionHandler === undefined) {return;} // menu action handler not registered

	var id_array = this.grid.getSelectedItemIds("|").split("|");  //supports multi-select
	this.eActionArgs = {};
	this.initActionArgs(this.eActionArgs);
	
	if (id_array.length == 1) {
		this.baseMenuActionHandler.updateActionContextArgsForRowId(this.eActionArgs, id_array[0]);
		var col = this.lockIconColumnNo;
		if (col && col >= 0 && this.eActionArgs.lockStatus !== undefined) {//update icon
			this.gridSetCellValue(id_array[0],this.lockIconColumnNo,fn_GetLockedCellIconFormatByStatusCode(this.icons,this.eActionArgs.lockStatus));}		
	}

	this.baseMenuActionHandler.buildContextMenuForThisRow(eArg.menuItems, this.gridContextMenu, id_array, this.eActionArgs);
	return true;
};

//+++++  BEGIN Grid's custom grid handlers
treeGridHandlerClass.prototype.onGridMenuClick = function treeGridHandlerClass_onGridMenuClick(menuChoice) {
  if (!this.baseMenuActionHandler || this.baseMenuActionHandler === undefined) {return;} // menu action handler not registered
  var selectedId = this.grid.getSelectedID(); //selected grid row
  if (!selectedId || typeof(selectedId) == "undefined" || selectedId === "" || selectedId === "NOTHING_MSG") {
       return;
  }
  var menuItem = this.baseMenuActionHandler.getContextMenuItemOfMenuIndex(this.gridContextMenu, menuChoice);
  if (!menuItem) {return;}
  //var eActionArgs = {};
  //this.initActionArgs(eActionArgs,selectedId);
  this.eActionArgs.actionSource = "menu";

  //debugger;
  var checkMsg = this.baseMenuActionHandler.executeAction(this.eActionArgs, menuItem);
  if (checkMsg !== "") {top.aras.AlertError(checkMsg); return;}
};

treeGridHandlerClass.prototype.onGetChildren = function treeGridHandlerClass_onGetChildren(eArg) {
	if (this.initialized === false) {return;}
	alert(eArg.rowId);
};

treeGridHandlerClass.prototype.onToolbarKeyPress = function treeGridHandlerClass_onToolbarKeyPress(eArg) {
	if (this.initialized === false) {return;}
	// eArg.key.keyCode  === 13  (ENTER)
	alert(eArg.key.keyCode);
};

treeGridHandlerClass.prototype.onGridKeyPress = function treeGridHandlerClass_onGridKeyPress(eArg) {
	if (this.initialized === false) {return;}
	// eArg.key.keyCode  === 13  (ENTER)
};

treeGridHandlerClass.prototype.onGridClick = function treeGridHandlerClass_onGridClick(eArg) {
	if (this.initialized === false) {return;}
	
	if (this.getGridRowUserData(eArg.rowId, "reloadNextLevels", "0") === "1"  && eArg.column !== undefined && eArg.column === 0) {
		// only process reloading for root rows
		this.grid.setRowIcons(eArg.rowId, "../images/cFolderReloading.svg", "../images/cFolderReloading.svg");
		this.grid.enable();
		var self = this;
		setTimeout(function(){
		try {
			} finally {
			fn_ReLoadThisFolder(self, eArg.rowId);
		}} , 50);
	}
};

treeGridHandlerClass.prototype.onGridDoubleClick = function treeGridHandlerClass_onGridDoubleClick(eArg) {
  if (!this.baseMenuActionHandler || this.baseMenuActionHandler === undefined) {return;} // menu action handler not registered

	// only process doubleclick, if row is NOT a structure row

	if (this.getGridRowUserData(eArg.rowId,"rowRelationshipType") !== this.structureRelName) {
		var menuItem = this.baseMenuActionHandler.getContextMenuItemOfOpenItemAction(this.gridContextMenu, this.getGridRowUserData(eArg.rowId,"rowRelationshipType"));
		if (!menuItem) {return;}
		this.eActionArgs = {};
		this.initActionArgs(this.eActionArgs,eArg.rowId);
		this.baseMenuActionHandler.updateActionContextArgsForRowId(this.eActionArgs, eArg.rowId);

		this.eActionArgs.actionId = menuItem.name;
		this.eActionArgs.actionSource = "doubleclick";

		var checkMsg = this.baseMenuActionHandler.executeAction(this.eActionArgs, menuItem);
		if (checkMsg !== "") {top.aras.AlertError(checkMsg); return;}
	}
};

treeGridHandlerClass.prototype.onGridLinkClick = function treeGridHandlerClass_onGridLinkClick(eArg) {
  if (!this.baseMenuActionHandler || this.baseMenuActionHandler === undefined) {return;} // menu action handler not registered
    var linkInfo = eArg.linkData.split("~");
	//alert(linkInfo[2]);
	var selectedId = linkInfo[0];
	var col = linkInfo[1];
	var cellVal = this.gridGetCellValue(selectedId,col);
	
	this.eActionArgs = {};
	this.eActionArgs.actionSource = "hyperlink";
	this.eActionArgs.rowItemType = this.getGridRowUserData(selectedId,"rowItemType");
	this.eActionArgs.rowOfGroupName = this.getGridRowUserData(selectedId,"rowOfGroupName");
	this.eActionArgs.rowItemId = this.getGridRowUserData(selectedId,"rowItemID");
	this.eActionArgs.rowNewItemId = this.getGridRowUserData(selectedId,"rowNewItemId");

	this.baseMenuActionHandler.executeLink(this.eActionArgs, linkInfo[2], cellVal);
};
//^^^^^  END Grid's custom grid handlers

// =======  Other helper functions  ========
//-----------------
fn_ReLoadThisFolder = function (gridHandler, rowId) {
	var dataItems = [];
	dataItems[0] = gridHandler.GetGridData(gridHandler.structureNodeTypeName, gridHandler.getGridRowUserData(rowId,"rowItemID"),false, "*");  // get all sub levels of this folder

	// update data already loaded
	gridHandler.gridData_AML[gridHandler.getGridRowUserData(rowId,"rootRowDataIndex")] = dataItems[0];

	gridHandler.DrawGridContent(dataItems, true);
	gridHandler.grid.enable();
	gridHandler.grid.setRowIcons(rowId, gridHandler.icons[gridHandler.structureNodeTypeName], gridHandler.icons[gridHandler.structureNodeTypeName]);
	gridHandler.setGridRowUserData(rowId, "reloadNextLevels", "0");
	gridHandler.grid.openItem(rowId);
};

//-----------------
fn_ReadVariableValue = function (variableName, defaultValue) {
	if (!defaultValue || defaultValue === undefined) {defaultValue="";}
	var variable_dom = top.aras.getItemFromServerByName("Variable", variableName, "value,default_value");
	if (variable_dom) {return variable_dom.getProperty("value",defaultValue);}
	else {return defaultValue;}
};

fn_GetAliasIdOfCurrentUser = function() {
  var aliasId = innovator.getUserAliases();

  if (aliasId)  {
    aliasId = aliasId.substr(0,32);
    var alias = innovator.getItemById("Identity", aliasId);
    if (alias.getItemCount()==1) {
      return alias.getAttribute("id");
    }
  }
  return "";
};

///==================
///  MAIN
///==================
function refreshGridContainerSize() {
	 var actualHeight = window.innerHeight ||
                      document.documentElement.clientHeight ||
                      document.body.clientHeight ||
                      document.body.offsetHeight;
	actualHeight = parseInt(actualHeight) - 28;

	var actualWidth = window.innerWidth ||
                      document.documentElement.clientWidth ||
                      document.body.clientWidth ||
                      document.body.offsetWidth;
	actualWidth = parseInt(actualWidth) -20;
	
	var gridElement = document.getElementById("grid1");
	gridElement.style.height = (actualHeight)+"px";
	gridElement.style.width = (actualWidth)+"px";
}

// add HTML to body to hold toobar and grid controls
htmlText = '<table id="main_table" style="overflow:hidden; width: 100%; height: 100%; position: absolute; top: 0px; left: 0px;" cellspacing="0" cellpadding="0">' +
							'<tr style="vertical-align: top;">' +
								'<td id="toolbar1" style="height: 28px;"></td>' +
							'</tr>' +
							'<tr style="vertical-align: top;">' +
								'<td id="grid1" style="height: 100%;"></td>' +
								'<div id="grid_loadingInProgress" style="top: 31px; width: 100%; height: 100%; position: absolute; padding-top: 20px; z-index: 100; background-color: #ffffff;">' +
									'<center><b>Loading...<img src="../images/Progress.gif" /></b></center>' +
								'</div>' +
							'</tr>' +
						'</table>';
			
var b = document.body;
b.setAttribute('style', 'overflow: hidden; position: relative; width: 100%;height: 100%;margin: 0px;padding: 0px; overflow:hidden;');

var mainDiv = document.createElement('div');
mainDiv.setAttribute('style', 'position: absolute; top: 0px; left: 0px; width: 100%; height: 100%;');
mainDiv.innerHTML = htmlText;
document.body.appendChild(mainDiv);
refreshGridContainerSize();


// Init - Grid Handler
function initTreeGrid() {
	top.TreeGridHandler = new treeGridHandlerClass();
	top.TreeGridHandler.setGridConfiguration(new TreeGridConfiguration("",""));
	
	//identify the TOC Item Type the form was started from
	if (!document.thisItem) { 
	    // assumes form with this logic got started from a TOCview
		// sdelectedId holds the path to the selected "ItemType" separated by "/"   (i.e.  Design/Part)
	
		//debugger;
		var selectedTOCitem = "";
		var mainTreeApplet = top.main.tree.mainTreeApplet;
		if (mainTreeApplet.selectedItemKey)  {selectedTOCitem=mainTreeApplet.selectedItemKey;}
		else {selectedTOCitem = top.main.tree.mainTreeApplet.getSelectedID();}
			
		var tocPath = selectedTOCitem.split("/");
		topItemType = tocPath[tocPath.length-1];
		
		isStartedFromTOCview = true;
	}
	else {
		topItemType = document.thisItem.getType();
	}
	
	top.TreeGridHandler.CONFIG.applyToItemType = topItemType;
	//alert(topItemType);
	top.TreeGridHandler.CONFIG.loadConfigItem();  // if no configName is passed, logic will be applied to find relevant configuration of 'applyToItemType'
	if (!top.TreeGridHandler.CONFIG.isConfigItemLoaded()) {return;}  //## maybe add error message later !!
	
	isStartedFromTOCview = top.TreeGridHandler.CONFIG.isStartedFromTOCview;
	if (isStartedFromTOCview) {isStartedFromTab = false;}
	
	top.TreeGridHandler.setMenuActionHandler(new BaseMenuActionHandler());
	top.TreeGridHandler.setCustomMenuActionHandler (new customMenuAction());
	
	top.TreeGridHandler.initialize();
}

initTreeGrid();

// 
window.addEventListener("resize", function () {
	refreshGridContainerSize();
});

]]></method_code>
  <method_type>JavaScript</method_type>
  <owned_by_id keyed_name="Innovator Admin" type="Identity">DBA5D86402BF43D5976854B8B48FCDD1</owned_by_id>
  <name>cFolderStructure GridHandler</name>
 </Item>
</AML>